<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twibbon Maulid Nabi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --light-grey: #f0f2f5;
            --dark-text: #333;
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: var(--dark-text);
            padding: 20px;
        }

        .editor-container {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        h1 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .steps {
            color: #6c757d;
            margin-bottom: 25px;
        }

        #canvas-container {
            position: relative;
            display: inline-block;
            cursor: grab;
            margin-bottom: 20px;
            touch-action: none; /* Mencegah scrolling browser saat menyentuh kanvas */
            border: 2px solid #eee;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .zoom-controls {
            display: flex;
            gap: 10px;
        }

        .btn, .btn-label {
            display: inline-block;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            text-decoration: none;
        }

        .btn-label {
            background-color: var(--primary-color);
        }
        .btn-label:hover {
            background-color: #0056b3;
        }

        .btn {
            background-color: var(--secondary-color);
        }
        .btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .btn-zoom {
            width: 45px;
            height: 45px;
            font-size: 24px;
            padding: 0;
            line-height: 45px;
            background-color: #f8f9fa;
            color: var(--dark-text);
            border: 1px solid #ddd;
        }
        .btn-zoom:hover {
             background-color: #e2e6ea;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <h1>Twibbon Maulid Nabi ðŸŒ™</h1>
        <p class="steps">1. Pilih Foto &nbsp; | &nbsp; 2. Atur Posisi & Ukuran &nbsp; | &nbsp; 3. Unduh</p>

        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="controls">
            <input type="file" id="upload" accept="image/*">
            <label for="upload" class="btn-label">Pilih Foto</label>
            <div class="zoom-controls">
                <button id="zoomOutBtn" class="btn btn-zoom" disabled>-</button>
                <button id="zoomInBtn" class="btn btn-zoom" disabled>+</button>
            </div>
        </div>
        
        <button id="downloadBtn" class="btn" disabled>Unduh Twibbon</button>
    </div>

    <script>
        // --- Konfigurasi & Inisialisasi ---
        const CANVAS_SIZE = 1080;
        const TWIBBON_SRC = "TWIBBON MAULID NABI.png";
        const ZOOM_SENSITIVITY = 0.1;

        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const uploadInput = document.getElementById("upload");
        const downloadBtn = document.getElementById("downloadBtn");
        const zoomInBtn = document.getElementById("zoomInBtn");
        const zoomOutBtn = document.getElementById("zoomOutBtn");

        canvas.width = CANVAS_SIZE;
        canvas.height = CANVAS_SIZE;

        const twibbon = new Image();
        twibbon.crossOrigin = "anonymous";
        twibbon.src = TWIBBON_SRC;

        const userImage = new Image();
        userImage.crossOrigin = "anonymous";
        
        let imageState = {
            x: 0,
            y: 0,
            scale: 1,
            isDragging: false,
            lastX: 0,
            lastY: 0,
            lastTouchDistance: 0
        };

        // --- Fungsi Utama ---
        twibbon.onload = () => {
            draw();
        };

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (userImage.src) {
                ctx.drawImage(
                    userImage,
                    imageState.x,
                    imageState.y,
                    userImage.width * imageState.scale,
                    userImage.height * imageState.scale
                );
            }
            ctx.drawImage(twibbon, 0, 0, canvas.width, canvas.height);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                userImage.src = e.target.result;
                userImage.onload = () => {
                    // Reset state dan atur gambar di tengah
                    const scale = Math.max(canvas.width / userImage.width, canvas.height / userImage.height);
                    imageState.scale = scale;
                    imageState.x = (canvas.width - userImage.width * scale) / 2;
                    imageState.y = (canvas.height - userImage.height * scale) / 2;
                    
                    draw();
                    
                    downloadBtn.disabled = false;
                    zoomInBtn.disabled = false;
                    zoomOutBtn.disabled = false;
                };
            };
            reader.readAsDataURL(file);
        }

        function downloadImage() {
            const link = document.createElement("a");
            link.download = "Twibbon-Maulid-Nabi.png";
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        // --- Logika Penyatuan Event (DRY) ---
        function getEventPosition(event) {
            const rect = canvas.getBoundingClientRect();
            // Scaling factor diperlukan karena ukuran display CSS kanvas mungkin berbeda dari ukuran resolusinya
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (event.touches && event.touches.length > 0) {
                // Untuk sentuhan
                return {
                    x: (event.touches[0].clientX - rect.left) * scaleX,
                    y: (event.touches[0].clientY - rect.top) * scaleY
                };
            }
            // Untuk mouse
            return {
                x: (event.clientX - rect.left) * scaleX,
                y: (event.clientY - rect.top) * scaleY
            };
        }

        function onPointerDown(event) {
            if (!userImage.src) return;
            event.preventDefault();
            imageState.isDragging = true;
            canvas.style.cursor = 'grabbing';
            
            if (event.touches && event.touches.length === 2) {
                imageState.lastTouchDistance = getTouchDistance(event.touches);
            } else {
                const { x, y } = getEventPosition(event);
                imageState.lastX = x;
                imageState.lastY = y;
            }
        }
        
        function onPointerMove(event) {
            if (!imageState.isDragging) return;
            event.preventDefault();

            // Pinch-to-zoom untuk mobile
            if (event.touches && event.touches.length === 2) {
                const newDist = getTouchDistance(event.touches);
                const factor = newDist / imageState.lastTouchDistance;
                const touchCenter = getTouchCenter(event.touches);
                adjustScale(factor, touchCenter.x, touchCenter.y);
                imageState.lastTouchDistance = newDist;
            } 
            // Dragging untuk mouse dan sentuhan tunggal
            else if (!event.touches || event.touches.length === 1) {
                const { x, y } = getEventPosition(event);
                const dx = x - imageState.lastX;
                const dy = y - imageState.lastY;
                imageState.x += dx;
                imageState.y += dy;
                imageState.lastX = x;
                imageState.lastY = y;
                draw();
            }
        }

        function onPointerUp() {
            imageState.isDragging = false;
            canvas.style.cursor = 'grab';
            imageState.lastTouchDistance = 0;
        }

        // --- Logika Zoom Terpusat ---
        function adjustScale(factor, centerX, centerY) {
            // Menyesuaikan posisi agar zoom terjadi di titik pusat (cursor atau pinch center)
            imageState.x = centerX - (centerX - imageState.x) * factor;
            imageState.y = centerY - (centerY - imageState.y) * factor;
            imageState.scale *= factor;
            imageState.scale = Math.max(0.1, imageState.scale); // Batasi zoom out
            draw();
        }
        
        function handleWheel(event) {
            if (!userImage.src) return;
            event.preventDefault();
            const { x, y } = getEventPosition(event);
            const scaleFactor = event.deltaY < 0 ? 1 + ZOOM_SENSITIVITY : 1 - ZOOM_SENSITIVITY;
            adjustScale(scaleFactor, x, y);
        }

        // --- Fungsi Bantuan ---
        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        function getTouchCenter(touches) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = (touches[0].clientX + touches[1].clientX) / 2;
            const clientY = (touches[0].clientY + touches[1].clientY) / 2;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }


        // --- Event Listeners ---
        uploadInput.addEventListener("change", handleFileUpload);
        downloadBtn.addEventListener("click", downloadImage);
        
        // Listeners untuk kontrol zoom
        zoomInBtn.addEventListener("click", () => adjustScale(1 + ZOOM_SENSITIVITY, canvas.width / 2, canvas.height / 2));
        zoomOutBtn.addEventListener("click", () => adjustScale(1 - ZOOM_SENSITIVITY, canvas.width / 2, canvas.height / 2));

        // Listeners untuk mouse
        canvas.addEventListener("mousedown", onPointerDown);
        canvas.addEventListener("mousemove", onPointerMove);
        window.addEventListener("mouseup", onPointerUp);
        canvas.addEventListener("mouseleave", onPointerUp); // Hentikan drag jika mouse keluar canvas
        
        // Listeners untuk sentuhan (mobile)
        canvas.addEventListener("touchstart", onPointerDown);
        canvas.addEventListener("touchmove", onPointerMove);
        canvas.addEventListener("touchend", onPointerUp);
        canvas.addEventListener("touchcancel", onPointerUp);

        // Listener untuk zoom dengan scroll
        canvas.addEventListener("wheel", handleWheel);

    </script>
</body>
</html>